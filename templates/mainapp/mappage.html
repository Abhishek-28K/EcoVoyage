<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <style>
         /* Same CSS as before */
         .locationiq-bounds {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
            border-radius: 4px;
        }

        .locationiq-bounds a,
        .locationiq-bounds a:hover {
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            width: 26px;
            height: 26px;
            line-height: 26px;
            display: block;
            text-align: center;
            text-decoration: none;
            color: black;
        }

        .locationiq-bounds a,
        .layout-control-layers-toggle {
            background-position: 50% 50%;
            background-repeat: no-repeat;
            display: block;
        }

        .locationiq-bounds a:hover {
            background-color: #f4f4f4;
        }

        .locationiq-bounds a:first-child {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .locationiq-bounds a:last-child {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            border-bottom: none;
        }

        .locationiq-bounds a.leaflet-disabled {
            cursor: default;
            background-color: #f4f4f4;
            color: #bbb;
        }

        .locationiq-control {
            position: relative;
            z-index: 800;
            pointer-events: visiblePainted;
            pointer-events: auto;
            float: left;
            clear: both;
            cursor: auto;
        }

        .autocomplete-suggestions {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
            border-radius: 4px;
        }

        .autocomplete-suggestions a,
        .autocomplete-suggestions a:hover {
            background-color: #fff;
            border-bottom: 1px solid #ccc;
            width: 26px;
            height: 26px;
            line-height: 26px;
            display: block;
            text-align: center;
            text-decoration: none;
            color: black;
        }

        .autocomplete-suggestions a,
        .layout-control-layers-toggle {
            background-position: 50% 50%;
            background-repeat: no-repeat;
            display: block;
        }

        .autocomplete-suggestions a:hover {
            background-color: #f4f4f4;
        }

        .autocomplete-suggestions a:first-child {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .autocomplete-suggestions a:last-child {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            border-bottom: none;
        }

        .autocomplete-suggestions a.leaflet-disabled {
            cursor: default;
            background-color: #f4f4f4;
            color: #bbb;
        }

        .locationiq-autocomplete-input {
            box-sizing: border-box;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            border: none;
            border-radius: 4px;
            padding-left: 26px;
            text-indent: 6px;
            font-size: 14px;
            background-color: transparent;
            cursor: pointer;
        }

        .locationiq-autocomplete-control {
            width: 26px;
            height: 26px;
            background-color: white;
            -webkit-transition: width .1s, height .1s;
            -moz-transition: width .1s, height .1s;
            -ms-transition: width .1s, height .1s;
            -o-transition: width .1s, height .1s;
            transition: width .1s, height .1s;
            z-index: 810;
            box-sizing: content-box;
        }

        .locationiq-autocomplete-expanded {
            width: 280px;
            height: 44px;
        }

        .locationiq-autocomplete-expanded .locationiq-autocomplete-input {
            padding-right: 30px;
            padding-top: 5px;
            padding-bottom: 5px;
            line-height: 32px;
        }

        .locationiq-reset-control {
            display: none;
            position: absolute;
            right: 0;
            width: 26px;
            height: 100% !important;
            padding-right: 2px;
            text-align: center;
            vertical-align: middle;
            font: normal 18px/26px 'Lucida Console', Monaco, monospace;
            background-color: transparent;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .locationiq-autocomplete-expanded .locationiq-reset-control {
            display: table-cell;
            background-color: inherit;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .locationiq-autocomplete-expanded .locationiq-reset-control.leaflet-locationiq-hidden {
            display: none;
        }

        .locationiq-autocomplete-search-icon {
            position: absolute;
            height: 100%;
            background-image: url('https://maps.locationiq.com/v3/libs/autocomplete/images/search.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 16px;
            z-index: 10;
            padding-left: 7px;
        }

        .locationiq-bounds a.locationiq-autocomplete-search-icon {
            border-radius: 4px;
            border-bottom: 0;
            height: 100%;
        }

        .locationiq-bounds a.locationiq-autocomplete-search-icon:not(:hover) {
            background-color: transparent;
        }

        .locationiq-autocomplete-expanded a.locationiq-autocomplete-search-icon {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .locationiq-autocomplete-search-icon.leaflet-locationiq-loading {
            background-image: url('https://maps.locationiq.com/v3/libs/autocomplete/images/loading.gif');
        }

        @media only screen and (min--moz-device-pixel-ratio: 1.25),
        only screen and (-o-min-device-pixel-ratio: 2.5/2),
        only screen and (-webkit-min-device-pixel-ratio: 1.25),
        only screen and (min-device-pixel-ratio: 1.25),
        only screen and (min-resolution: 120dpi),
        only screen and (min-resolution: 1.25dppx) {
            .locationiq-autocomplete-search-icon {
                background-image: url('https://maps.locationiq.com/v3/libs/autocomplete/images/search@2x.png');
            }

            .locationiq-autocomplete-search-icon.leaflet-locationiq-loading {
                background-image: url('https://maps.locationiq.com/v3/libs/autocomplete/images/loading@2x.gif');
            }
        }

        .locationiq-autocomplete-input:focus {
            outline: none;
            cursor: text;
        }

        .locationiq-autocomplete-input::-ms-clear {
            display: none;
        }

        .autocomplete-suggestions {
            width: 100%;
            position: absolute;
            left: 0;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .autocomplete-suggestion {
            font-size: 13px;
            padding: 7px;
            background-color: white;
            border-top: 1px solid #f1f1f1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .autocomplete-suggestion-name {
            line-height: 20px;
        }

        .autocomplete-suggestion-address {
            font-size: 12px;
            line-height: 12px;
            color: #666;
        }

        .autocomplete-suggestion:first-child {
            border: none;
        }

        .autocomplete-suggestion:hover {
            background-color: #d5f1f3;
            border-color: #d5f1f3;
        }

        .autocomplete-selected,
        .autocomplete-selected:hover {
            background-color: #b2e3e7;
            border-color: #b2e3e7;
        }

        .locationiq-autocomplete-message {
            font-size: 13px;
            padding: 7px;
            background-color: white;
            overflow-x: auto;
            white-space: nowrap;
        }

        .locationiq-autocomplete-message li {
            cursor: default;
        }

        #search-box-source,
        #search-box-destination {
            width: 200px;
            height: 40px;
            padding: 10px;
            font-size: 18px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        #search-box-source:focus,
        #search-box-destination:focus {
            outline: none;
            border-color: #00a5b5;
            box-shadow: 0 0 5px rgba(0, 165, 181, 0.5);
        }

        #calculate-button {
            height: 40px;
            background: #00a5b5;
            color: #fff;
            font-size: 18px;
            padding: 0 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #calculate-button:hover {
            background: #007d8a;
        }

        #result {
            padding-left: 20px;
            padding-top: 10px;
            font-size: 18px;
        }
        body {
            background-color: #f4f9f4;
            font-family: Arial, sans-serif;
        }
        .form-container {
            background-color: #74b49b;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .form-container h2 {
            text-align: center;
            color: #f4f9f4;
        }
        .form-container label {
            display: block;
            margin-bottom: 8px;
            color: #f4f9f4;
        }
        .form-container input,
        .form-container select,
        .form-container button {
            width: 100%;
            padding: 10px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .form-container input:focus,
        .form-container select:focus,
        .form-container button:focus {
            outline: none;
            border-color: #00a5b5;
            box-shadow: 0 0 5px rgba(0, 165, 181, 0.5);
        }
        .form-container button {
            background-color: #fff;
            color: #74b49b;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .form-container button:hover {
            background-color: #f4f9f4;
            color: #74b49b;
        }
    </style>
</head>
<body>
    <div class="form-container">
        {%csrf_token%}
        <h2>Calculate Carbon Footprint Of Your Trips</h2>
        <input type="text" id="search-box-source" placeholder="Source" />
        <input type="text" id="search-box-destination" placeholder="Destination" />
        
        <label for="mode-of-transport">Mode of Transport</label>
        <select id="mode-of-transport">
            <option value="bus">Bus</option>
            <option value="train">Train</option>
            <option value="metro">Metro</option>
            <option value="car">Car</option>
            <option value="two_wheeler">Two Wheeler</option>
            <option value="bicycle">Bicycle</option>
            <option value="walk">Walk</option>
        </select>
        
        <label for="is-electric">Is the transport electric?</label>
        <select id="is-electric">
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>
        
        <label for="time-taken">Time Taken</label>
        <input type="text" id="time-taken" placeholder="e.g., 30 minutes" />
        
        <label for="date">Date</label>
        <input type="date" id="date" />

        <button id="submit-button">Submit</button>
        <div id="result"></div>
    </div>
    
    <script>
        $(document).ready(function() {
            const API_KEY = 'pk.8c9f36b3cfd8974de4ea7379ee5fac2a';
            const baseUrl = 'https://api.locationiq.com/v1/autocomplete.php';
            const limit = 5;

            function autocomplete(selector) {
                $(selector).autocomplete({
                    serviceUrl: baseUrl,
                    params: {
                        key: API_KEY,
                        limit: limit,
                    },
                    paramName: 'q',
                    transformResult: function(response) {
                        return {
                            suggestions: $.map(JSON.parse(response), function(item) {
                                return { 
                                    value: item.display_name,
                                    data: { 
                                        lat: item.lat, 
                                        lon: item.lon 
                                    } 
                                };
                            })
                        };
                    },
                    onSelect: function (suggestion) {
                        $(selector).data('lat', suggestion.data.lat);
                        $(selector).data('lon', suggestion.data.lon);
                    }
                });
            }

            autocomplete('#search-box-source');
            autocomplete('#search-box-destination');

            $('#submit-button').click(function() {
                const source = $('#search-box-source').val();
                const destination = $('#search-box-destination').val();
                const sourceLat = $('#search-box-source').data('lat');
                const sourceLon = $('#search-box-source').data('lon');
                const destinationLat = $('#search-box-destination').data('lat');
                const destinationLon = $('#search-box-destination').data('lon');
                const date = $('#date').val();
                const timeTaken = $('#time-taken').val();
                const isElectric = $('input[name="is_electric"]:checked').val();
                const modeOfTransport = $('#mode-of-transport').val();

                if (sourceLat && sourceLon && destinationLat && destinationLon) {
                    const coordinates = `${sourceLon},${sourceLat};${destinationLon},${destinationLat}`;
                    const url = `https://us1.locationiq.com/v1/directions/driving/${coordinates}?key=${API_KEY}&alternatives=false&steps=true&geometries=geojson&overview=full&annotations=true`;

                    $.get(url, function(response) {
                        const distance = response.routes[0].distance / 1000; // Convert meters to kilometers
                        const distanceFormatted = distance.toFixed(2);

                        $.ajax({
                            url: '{% url "store_distance_data" %}', // Use Django URL tag
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}' // CSRF token header
                            },
                            contentType: 'application/json',
                            data: JSON.stringify({
                                source: source,
                                destination: destination,
                                source_lat: sourceLat,
                                source_lon: sourceLon,
                                destination_lat: destinationLat,
                                destination_lon: destinationLon,
                                distance: distanceFormatted,
                                date: date,
                                time_taken: timeTaken,
                                is_electric: isElectric,
                                mode_of_transport: modeOfTransport
                            }),
                            success: function(response) {
                                $('#result').text('Distance: ' + distanceFormatted + ' km. ' + response.message);
                                $('#distance-form')[0].reset(); // Reset form
                            },
                            error: function() {
                                alert('Error storing data. Please try again.');
                            }
                        });
                    }).fail(function() {
                        alert('Error calculating distance. Please try again.');
                    });
                } else {
                    alert('Please select valid source and destination locations.');
                }
            });
        });
    </script>
</body>
</html>