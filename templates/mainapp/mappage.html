{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomePage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/api.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <style>
        body {
            background-color: #f4f9f4;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .form-container {
            background-color: #74b49b;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px; /* Reduced width for a more compact block */
            margin: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: #f4f9f4;
        }

        .form-container h2 {
            text-align: center;
            color: #f4f9f4;
            margin-bottom: 20px;
        }

        .form-container label {
            display: block;
            margin-bottom: 8px;
            color: #f4f9f4;
            font-weight: bold;
        }

        .form-container input,
        .form-container select,
        .form-container button {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            transition: all 0.3s ease;
        }

        .form-container input:focus,
        .form-container select:focus,
        .form-container button:focus {
            outline: none;
            border-color: #00a5b5;
            box-shadow: 0 0 5px rgba(0, 165, 181, 0.5);
        }

        .form-container input::placeholder,
        .form-container select {
            color: #aaa;
        }

        .form-container button {
            background-color: #fff;
            color: #74b49b;
            font-size: 16px;
            cursor: pointer;
        }

        .form-container button:hover {
            background-color: #f4f9f4;
            color: #74b49b;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .form-container .radio-group {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding:0px ; /*Reduced gap for compactness */
        }

        .form-container .radio-group input {
            margin-right: 5px;
            box-shadow: none; /* Removed box-shadow from radio buttons */
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Carbon Footprint Calculator Per Trip</h2>
        <form id="distance-form" method="post" action="{% url 'store_distance_data' %}">
            {% csrf_token %}
            <label for="source">Source</label>
            <input type="text" id="search-box-source" name="source" placeholder="Source" required />
            <label for="destination">Destination</label>
            <input type="text" id="search-box-destination" name="destination" placeholder="Destination" required />
            <label for="date">Date</label>
            <input type="date" id="date" name="date" placeholder="Date (YYYY-MM-DD)" required />
            <label for="time-taken">Time Taken</label>
            <input type="text" id="time-taken" name="time_taken" placeholder="Time In Minutes" required />
            <label for="mode-of-transport">Mode Of Transport</label>
            <select id="mode-of-transport" name="mode_of_transport" required>
                <option value="">Select Mode</option>
                <option value="bus">Bus</option>
                <option value="train">Train</option>
                <option value="metro">Metro</option>
                <option value="car">Car</option>
                <option value="two_wheeler">Two Wheeler</option>
                <option value="bicycle">Bicycle</option>
                <option value="walk">Walk</option>
            </select>
            <div class="radio-group">
                <label for="is_electric">Is the transport electric?</label>
                <input type="radio" id="is_electric_yes" name="is_electric" value="yes" required>
                <label for="is_electric_yes">Yes</label>
                <input type="radio" id="is_electric_no" name="is_electric" value="no" required>
                <label for="is_electric_no">No</label>
            </div>
            <button type="submit" id="store-button">Submit</button>
        </form>
    </div>
    <script>
        $(document).ready(function() {
            const API_KEY = 'pk.8c9f36b3cfd8974de4ea7379ee5fac2a';
            const baseUrl = 'https://api.locationiq.com/v1/autocomplete.php';
            const limit = 5;

            function autocomplete(selector) {
                $(selector).autocomplete({
                    serviceUrl: baseUrl,
                    params: {
                        key: API_KEY,
                        limit: limit,
                    },
                    paramName: 'q',
                    transformResult: function(response) {
                        return {
                            suggestions: $.map(JSON.parse(response), function(item) {
                                return { 
                                    value: item.display_name,
                                    data: { 
                                        lat: item.lat, 
                                        lon: item.lon 
                                    } 
                                };
                            })
                        };
                    },
                    onSelect: function (suggestion) {
                        $(selector).data('lat', suggestion.data.lat);
                        $(selector).data('lon', suggestion.data.lon);
                    }
                });
            }

            autocomplete('#search-box-source');
            autocomplete('#search-box-destination');

            $('#distance-form').submit(function(event) {
                event.preventDefault(); // Prevent the default form submission

                const source = $('#search-box-source').val();
                const destination = $('#search-box-destination').val();
                const sourceLat = $('#search-box-source').data('lat');
                const sourceLon = $('#search-box-source').data('lon');
                const destinationLat = $('#search-box-destination').data('lat');
                const destinationLon = $('#search-box-destination').data('lon');
                const date = $('#date').val();
                const timeTaken = $('#time-taken').val();
                const is_electric = $('input[name="is_electric"]:checked').val();
                const modeOfTransport = $('#mode-of-transport').val();

                if (sourceLat && sourceLon && destinationLat && destinationLon) {
                    const coordinates = `${sourceLon},${sourceLat};${destinationLon},${destinationLat}`;
                    const url = `https://us1.locationiq.com/v1/directions/driving/${coordinates}?key=${API_KEY}&alternatives=false&steps=true&geometries=geojson&overview=full&annotations=true`;

                    $.get(url, function(response) {
                        const distance = response.routes[0].distance / 1000; // Convert meters to kilometers
                        const distanceFormatted = distance.toFixed(2);

                        $.ajax({
                            url: '{% url "store_distance_data" %}', // Use Django URL tag
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}' // CSRF token header
                            },
                            contentType: 'application/json',
                            data: JSON.stringify({
                                source: source,
                                destination: destination,
                                source_lat: sourceLat,
                                source_lon: sourceLon,
                                destination_lat: destinationLat,
                                destination_lon: destinationLon,
                                distance: distanceFormatted,
                                date: date,
                                time_taken: timeTaken,
                                is_electric: is_electric,
                                mode_of_transport: modeOfTransport
                            }),
                            success: function(response) {
                                location.reload();
                            },
                            error: function() {
                                alert('Error storing data. Please try again.');
                            }
                        });
                    }).fail(function() {
                        alert('Error calculating distance. Please try again.');
                    });
                } else {
                    alert('Please select valid source and destination locations.');
                }
            });
        });
    </script>
</body>
</html>
